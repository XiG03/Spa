@using SpaBookingWeb.ViewModels.Client
@using System.Globalization
@model Step5ViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Xác nhận Đặt lịch & Thanh toán";
    var session = Model.CurrentSession;
    var culture = new CultureInfo("vi-VN");
    var initialRemaining = session.TotalAmount - Model.DepositAmount;

    string GetStaffName(int? staffId)
    {
        if (staffId == null) return "Bất kỳ ai";
        var staff = Model.Staffs?.FirstOrDefault(s => s.Id == staffId);
        return staff != null ? staff.Name : "Bất kỳ ai";
    }

    string GetStaffAvatar(int? staffId)
    {
        if (staffId == null) return null;
        var staff = Model.Staffs?.FirstOrDefault(s => s.Id == staffId);
        return staff?.Avatar;
    }
}

<style>
    .payment-radio:checked + div {
        border-color: #ec4899;
        background-color: #fdf2f8;
        box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.1), 0 2px 4px -1px rgba(236, 72, 153, 0.06);
    }
    .payment-radio:checked + div .check-icon {
        opacity: 1;
        transform: scale(1);
    }
</style>

<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <div class="mb-8">
        <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-sm border border-pink-100 dark:border-gray-800 flex flex-col md:flex-row gap-6 items-start md:items-center justify-between">
            <div>
                <h2 class="text-3xl font-black text-gray-900 dark:text-white mb-2">Xác nhận Đặt lịch</h2>
                <div class="flex items-center gap-4 text-gray-500 text-sm flex-wrap">
                    <span class="flex items-center gap-1 bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-100 px-2 py-0.5 rounded-md font-semibold">Bước 5/5</span>
                    <span class="flex items-center gap-1 text-primary font-medium">
                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                        Kiểm tra thông tin &amp; Thanh toán cọc
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-8 items-start relative">
        <div class="flex-1 w-full min-w-0 flex flex-col gap-6">
            
            <!-- REVIEW SECTIONS -->
            <section class="bg-white dark:bg-gray-900 rounded-2xl p-5 shadow-sm border border-pink-100 dark:border-gray-800 opacity-90 hover:opacity-100 transition-all">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold">
                            <span class="material-symbols-outlined text-lg">check</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Dịch vụ đã chọn</h3>
                            <div class="text-sm text-gray-500 mt-1">
                                @foreach(var mem in session.Members)
                                {
                                    <div class="mb-1"><span class="font-medium text-gray-900 dark:text-gray-300">@mem.Name:</span> @string.Join(", ", mem.SelectedServices.Select(s => s.Name))</div>
                                }
                            </div>
                        </div>
                    </div>
                    <a asp-action="Step2_Services" class="text-sm font-bold text-primary hover:text-primary-dark underline decoration-2 underline-offset-2">Sửa</a>
                </div>
            </section>

            <section class="bg-white dark:bg-gray-900 rounded-2xl p-5 shadow-sm border border-pink-100 dark:border-gray-800 opacity-90 hover:opacity-100 transition-all">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold">
                            <span class="material-symbols-outlined text-lg">check</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Thời gian</h3>
                            <p class="text-sm text-gray-500">@session.SelectedTime?.ToString(@"hh\:mm") - @session.SelectedDate?.ToString("dddd, dd/MM/yyyy", culture)</p>
                        </div>
                    </div>
                    <a asp-action="Step4_Time" class="text-sm font-bold text-primary hover:text-primary-dark underline decoration-2 underline-offset-2">Sửa</a>
                </div>
            </section>

            <!-- FORM NHẬP LIỆU & THANH TOÁN -->
            <section class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-xl shadow-pink-100/30 dark:shadow-none border-2 border-pink-100 dark:border-gray-800 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-primary"></div>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-md shadow-pink-300">4</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Thông tin &amp; Thanh toán cọc</h3>
                </div>

                <form asp-action="SubmitBooking" method="post" id="bookingForm">
                    <!-- HIỂN THỊ THÔNG BÁO LỖI TỪ CONTROLLER (NẾU CÓ) -->
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="mb-6 p-4 bg-red-50 text-red-700 rounded-xl border border-red-200 flex items-start gap-3 animate-fade-in-up">
                            <span class="material-symbols-outlined text-2xl shrink-0 mt-0.5">error</span>
                            <div>
                                <h4 class="font-bold">Đã xảy ra lỗi</h4>
                                <p class="text-sm">@TempData["ErrorMessage"]</p>
                            </div>
                        </div>
                    }

                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="mb-4 p-3 bg-red-50 text-red-500 rounded-lg text-sm border border-red-100">@Html.ValidationSummary(false)</div>
                    }

                    <div class="grid md:grid-cols-2 gap-5 mb-8">
                        <div class="space-y-1">
                            <label class="text-sm font-semibold text-gray-900 dark:text-gray-300">Họ và tên *</label>
                            <input asp-for="CurrentSession.CustomerInfo.FullName" name="FullName" class="w-full rounded-xl border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-gray-900 dark:text-white focus:ring-primary focus:border-primary font-medium" placeholder="Nhập họ tên" required/>
                        </div>
                        <div class="space-y-1">
                            <label class="text-sm font-semibold text-gray-900 dark:text-gray-300">Số điện thoại *</label>
                            <input asp-for="CurrentSession.CustomerInfo.Phone" name="Phone" class="w-full rounded-xl border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-gray-900 dark:text-white focus:ring-primary focus:border-primary font-medium" placeholder="09xxxxxxxx" required/>
                        </div>
                        <div class="space-y-1 md:col-span-2">
                            <label class="text-sm font-semibold text-gray-900 dark:text-gray-300">Email (Nhận vé điện tử)</label>
                            <input asp-for="CurrentSession.CustomerInfo.Email" name="Email" type="email" class="w-full rounded-xl border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-gray-900 dark:text-white focus:ring-primary focus:border-primary font-medium" placeholder="email@example.com"/>
                        </div>
                        <div class="space-y-1 md:col-span-2">
                            <label class="text-sm font-semibold text-gray-900 dark:text-gray-300">Ghi chú (Tùy chọn)</label>
                            <textarea asp-for="CurrentSession.CustomerInfo.Note" name="Note" class="w-full rounded-xl border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-gray-900 dark:text-white focus:ring-primary focus:border-primary resize-none" placeholder="Bạn có yêu cầu đặc biệt nào không?" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <!-- VOUCHER -->
                    <div class="mb-8 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                         <label class="text-sm font-bold text-gray-900 dark:text-white mb-2 block flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-lg">local_activity</span>
                            Mã giảm giá / Voucher
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="voucherCodeInput" name="VoucherCode" class="flex-1 rounded-xl border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm focus:ring-primary focus:border-primary uppercase placeholder:normal-case" placeholder="Nhập mã voucher (nếu có)">
                            <button type="button" onclick="checkVoucher()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 dark:bg-gray-800 dark:border-gray-600 dark:text-white px-4 py-2 rounded-xl text-sm font-bold transition-colors whitespace-nowrap">
                                Áp dụng
                            </button>
                        </div>
                        <div id="voucherMessage" class="mt-2 text-sm hidden"></div>
                    </div>

                    <div class="border-t border-dashed border-gray-200 dark:border-gray-800 my-8"></div>

                    <!-- PAYMENT -->
                    <div>
                        <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Phương thức thanh toán cọc</h4>
                        <p class="text-sm text-gray-500 mb-6">
                            Để giữ chỗ, vui lòng thanh toán trước khoản cọc <span class="font-bold text-primary">@Model.DepositAmount.ToString("N0") đ (@Model.DepositPercent%)</span>. 
                        </p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="payment_method" value="momo" class="payment-radio sr-only" checked/>
                                <div class="p-4 rounded-xl border-2 border-gray-100 bg-white dark:bg-gray-900 dark:border-gray-800 hover:border-pink-200 transition-all flex flex-col items-center gap-3 h-full relative overflow-hidden">
                                    <div class="w-12 h-12 rounded-lg bg-[#a50064] flex items-center justify-center text-white shadow-md mb-1">
                                        <span class="font-bold text-[10px]">MOMO</span>
                                    </div>
                                    <span class="font-bold text-gray-900 dark:text-white text-sm">Ví MoMo</span>
                                    <div class="check-icon absolute top-2 right-2 text-primary opacity-0 transform scale-50 transition-all duration-300">
                                        <span class="material-symbols-outlined">check_circle</span>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="payment_method" value="later" class="payment-radio sr-only"/>
                                <div class="p-4 rounded-xl border-2 border-gray-100 bg-white dark:bg-gray-900 dark:border-gray-800 hover:border-gray-300 transition-all flex flex-col items-center gap-3 h-full relative overflow-hidden">
                                    <div class="w-12 h-12 rounded-lg bg-gray-500 flex items-center justify-center text-white shadow-md mb-1">
                                        <span class="material-symbols-outlined">storefront</span>
                                    </div>
                                    <span class="font-bold text-gray-900 dark:text-white text-sm">Tại quầy</span>
                                    <div class="check-icon absolute top-2 right-2 text-gray-600 opacity-0 transform scale-50 transition-all duration-300">
                                        <span class="material-symbols-outlined">check_circle</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </form>
            </section>
        </div>

        <!-- RIGHT SIDEBAR -->
        <aside class="w-full lg:w-96 shrink-0 lg:sticky lg:top-24 h-fit">
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-xl border border-pink-100 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    Tóm tắt đơn hàng
                </h3>
                
                <div class="space-y-4 mb-6 relative">
                    <div class="absolute left-[7px] top-2 bottom-4 w-0.5 bg-pink-100 dark:bg-gray-800"></div>
                    @foreach(var mem in session.Members)
                    {
                        @foreach(var s in mem.SelectedServices)
                        {
                            <div class="relative pl-6">
                                <div class="absolute left-0 top-1.5 w-4 h-4 rounded-full border-2 border-primary bg-white dark:bg-gray-900"></div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-900 dark:text-white">@s.Name</p>
                                        <p class="text-xs text-gray-500 mt-0.5">@s.DurationMinutes phút</p>
                                        @if(session.IsGroupBooking) { <span class="text-[10px] bg-gray-100 dark:bg-gray-800 px-1 rounded text-gray-500">@mem.Name</span> }
                                    </div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">@s.Price.ToString("N0") đ</span>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="border-t border-dashed border-gray-200 dark:border-gray-800 my-4"></div>
                
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>Tạm tính</span>
                        <span id="ui-total">@session.TotalAmount.ToString("N0") đ</span>
                    </div>
                    
                    <div id="ui-discount-row" class="flex justify-between text-sm text-green-600 font-medium hidden">
                        <span>Voucher giảm giá</span>
                        <span id="ui-discount-amount">-0 đ</span>
                    </div>
                    
                    <div class="flex justify-between items-end pt-2 border-t border-gray-100 dark:border-gray-800 mt-2">
                        <span class="text-base font-bold text-gray-900 dark:text-white">Tổng cộng</span>
                        <span class="text-xl font-black text-gray-900 dark:text-white" id="ui-final-total">@session.TotalAmount.ToString("N0") đ</span>
                    </div>
                </div>

                <div class="bg-pink-50 dark:bg-pink-900/30 rounded-xl p-4 mb-4 border border-pink-100 dark:border-pink-800/50">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-semibold text-primary-dark dark:text-pink-300">Cần thanh toán ngay (Cọc)</span>
                        <span class="text-lg font-black text-primary" id="ui-deposit">@Model.DepositAmount.ToString("N0") đ</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>Thanh toán tại Spa</span>
                        <span id="ui-remaining">@initialRemaining.ToString("N0") đ</span>
                    </div>
                </div>

                <button type="button" onclick="document.getElementById('bookingForm').submit()" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-primary/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] mb-3 flex items-center justify-center gap-2">
                    <span>Thanh toán &amp; Đặt lịch</span>
                    <span class="material-symbols-outlined text-sm">arrow_forward</span>
                </button>
                
                <p class="text-center text-xs text-gray-500">
                    Bằng việc xác nhận, bạn đồng ý với <a class="underline text-primary" href="#">Điều khoản dịch vụ</a>.
                </p>
            </div>
        </aside>
    </div>
</div>

<script>
    sessionStorage.removeItem('appliedVoucher');

    function checkVoucher() {
        const code = document.getElementById('voucherCodeInput').value;
        const messageDiv = document.getElementById('voucherMessage');
        const discountRow = document.getElementById('ui-discount-row');
        const discountVal = document.getElementById('ui-discount-amount');
        const remainingVal = document.getElementById('ui-remaining');
        
        if (!code) {
            messageDiv.innerHTML = '<span class="text-red-500 text-sm">Vui lòng nhập mã voucher.</span>';
            messageDiv.classList.remove('hidden');
            return;
        }

        messageDiv.innerHTML = '<span class="text-gray-500 flex items-center gap-1 text-sm"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span> Đang xử lý...</span>';
        messageDiv.classList.remove('hidden');

        fetch('/Booking/CheckVoucher?code=' + encodeURIComponent(code), { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.isValid) {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-2 bg-green-50 text-green-700 p-3 rounded-lg border border-green-200 mt-2">
                        <span class="material-symbols-outlined text-lg mt-0.5">check_circle</span>
                        <div>
                            <p class="font-bold text-sm">Áp dụng thành công!</p>
                            <p class="text-xs mt-1 text-green-800">${data.message}</p>
                        </div>
                    </div>
                `;

                discountRow.classList.remove('hidden');
                discountVal.textContent = '-' + data.discountAmount.toLocaleString('vi-VN') + ' đ';
                remainingVal.textContent = data.remainingAmount.toLocaleString('vi-VN') + ' đ';
                remainingVal.classList.add('text-green-600', 'font-bold');

                sessionStorage.setItem('appliedVoucher', code);

            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start gap-2 bg-red-50 text-red-700 p-3 rounded-lg border border-red-200 mt-2">
                        <span class="material-symbols-outlined text-lg mt-0.5">error</span>
                        <span class="text-sm font-medium">${data.message}</span>
                    </div>
                `;
                
                discountRow.classList.add('hidden');
                remainingVal.textContent = data.remainingAmount.toLocaleString('vi-VN') + ' đ';
                remainingVal.classList.remove('text-green-600', 'font-bold');

                sessionStorage.removeItem('appliedVoucher');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageDiv.innerHTML = '<span class="text-red-500 text-sm">Lỗi kết nối server.</span>';
        });
    }

    document.getElementById('voucherCodeInput').addEventListener('input', function() {
        sessionStorage.removeItem('appliedVoucher');
        document.getElementById('ui-discount-row').classList.add('hidden');
        document.getElementById('voucherMessage').classList.add('hidden');
    });
</script>