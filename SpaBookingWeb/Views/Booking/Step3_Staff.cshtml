@using SpaBookingWeb.ViewModels.Client
@model Step3ViewModel
@{
    Layout = null;
    var currentMemberIndex = 1;
    // Đếm tổng số dịch vụ đã chọn để hiển thị ở thẻ tóm tắt đầu trang
    var totalServicesCount = Model.CurrentSession.Members.Sum(m => m.SelectedServices.Count);
}

<!DOCTYPE html>
<html class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Chọn Chuyên gia (Bước 3) - Lotus Spa</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ec4899", "primary-dark": "#be185d",
                        "background-light": "#fdf2f8", "background-dark": "#181012",
                        "text-main": "#1f2937", "text-muted": "#6b7280",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"], "sans": ["Inter", "sans-serif"] },
                }
            }
        }
    </script>
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .member-tab.active {
            background-color: #ec4899;
            color: white;
            border-color: #ec4899;
        }

        .staff-radio:checked+label {
            border-color: #ec4899;
            background-color: rgba(236, 72, 153, 0.05);
        }

        .staff-radio:checked+label .check-icon {
            opacity: 1;
        }

        /* Ẩn hiện vùng chọn chi tiết */
        .staff-selection-area {
            transition: all 0.3s ease;
            max-height: 2000px;
            opacity: 1;
            overflow: hidden;
        }

        .staff-selection-area.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Class ẩn item khi tìm kiếm */
        .staff-item-container.hidden-by-search {
            display: none !important;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-text-main antialiased min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white dark:bg-[#29151b] border-b border-pink-100 dark:border-[#4a2630] sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <div class="bg-primary/20 p-2 rounded-lg text-primary-dark">
                            <span class="material-symbols-outlined">spa</span>
                        </div>
                        <h1 class="text-xl font-bold tracking-tight text-text-main dark:text-white">Lotus Spa</h1>
                    </div>
                    <!-- SEARCH BAR -->
                    <div class="hidden md:flex relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-text-muted text-[20px]">search</span>
                        </div>
                        <input id="staff-search-input" onkeyup="searchStaff()"
                            class="block w-64 pl-10 pr-3 py-2 border-none rounded-xl bg-background-light dark:bg-[#361c23] text-sm text-text-main dark:text-white placeholder-text-muted focus:ring-2 focus:ring-primary"
                            placeholder="Tìm kiếm chuyên gia..." type="text" />
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <nav class="hidden md:flex gap-6 text-sm font-medium text-text-main dark:text-gray-300">
                        <a class="hover:text-primary transition-colors" href="#">Trang chủ</a>
                        <a class="hover:text-primary transition-colors" href="#">Lịch của tôi</a>
                        <a class="hover:text-primary transition-colors" href="#">Đối tác</a>
                    </nav>
                    <button
                        class="bg-primary hover:bg-primary-dark transition-colors text-white font-bold py-2 px-5 rounded-xl text-sm shadow-md shadow-pink-200 dark:shadow-none">
                        Đăng nhập
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- STEP INDICATOR -->
        <div class="mb-8">
            <div class="flex items-center justify-between w-full relative">
                <div
                    class="absolute left-0 top-1/2 -translate-y-1/2 w-full h-1 bg-gray-200 dark:bg-gray-800 rounded-full -z-10">
                </div>
                <div
                    class="absolute left-0 top-1/2 -translate-y-1/2 w-[60%] h-1 bg-primary rounded-full -z-10 transition-all duration-300">
                </div>
                <!-- Steps icons -->
                <div class="flex flex-col items-center gap-2">
                    <a asp-action="Index"
                        class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-lg hover:bg-primary-dark transition-colors"
                        title="Quay lại chọn Loại">1</a>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <a asp-action="Step2_Services"
                        class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-lg hover:bg-primary-dark transition-colors"
                        title="Quay lại chọn Dịch vụ">2</a>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-lg">
                        3</div>
                    <span class="text-xs font-bold text-primary">KTV</span>
                </div>
                <div class="flex flex-col items-center gap-2 opacity-50">
                    <div
                        class="w-8 h-8 rounded-full bg-white border-2 border-gray-200 text-text-muted flex items-center justify-center font-bold text-sm">
                        4</div>
                    <span class="text-xs font-medium text-text-muted">Giờ</span>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 items-start relative">
            <div class="flex-1 w-full min-w-0 flex flex-col gap-6">

                <!-- [MỚI] REVIEW STEP TRƯỚC (Giống thiết kế gốc) -->
                <section
                    class="bg-white dark:bg-[#29151b] rounded-2xl p-6 shadow-sm border border-pink-100 dark:border-[#4a2630] flex items-center justify-between opacity-80 hover:opacity-100 transition-opacity">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold text-sm shrink-0">
                            <span class="material-symbols-outlined text-lg">check</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-text-main dark:text-white">Dịch vụ</h3>
                            <p class="text-sm text-text-muted">@totalServicesCount dịch vụ đã chọn</p>
                        </div>
                    </div>
                    <a asp-action="Step2_Services"
                        class="text-primary font-semibold text-sm hover:underline px-3 py-1 flex items-center gap-1">
                        Thay đổi <span class="material-symbols-outlined text-sm">edit</span>
                    </a>
                </section>

                <!-- GROUP TABS (Nếu có nhiều thành viên) -->
                @if (Model.CurrentSession.IsGroupBooking)
                {
                    <div
                        class="bg-white dark:bg-[#29151b] rounded-2xl p-4 shadow-sm border border-pink-100 dark:border-[#4a2630]">
                        <h3 class="text-sm font-bold text-text-muted uppercase mb-3">Chọn chuyên gia cho:</h3>
                        <div class="flex gap-2 flex-wrap">
                            @foreach (var member in Model.CurrentSession.Members)
                            {
                                <button onclick="switchMember(@member.MemberIndex)" id="btn-member-@member.MemberIndex"
                                    class="member-tab px-4 py-2 rounded-xl border border-pink-100 text-sm font-bold transition-all hover:border-primary @(member.MemberIndex == 1 ? "active" : "")">
                                    <span class="flex items-center gap-2">
                                        <span class="material-symbols-outlined text-[18px]">person</span>
                                        @member.Name
                                    </span>
                                </button>
                            }
                        </div>
                    </div>
                }

                @foreach (var member in Model.CurrentSession.Members)
                {
                    <div id="panel-member-@member.MemberIndex"
                        class="member-panel @(member.MemberIndex == 1 ? "" : "hidden")">

                        <!-- OPTION SELECTION -->
                        <section class="bg-white dark:bg-[#29151b] rounded-2xl p-6 shadow-lg border-2 border-primary/20">
                            <div class="flex items-center gap-3 mb-6">
                                <h3 class="text-xl font-bold text-text-main dark:text-white">Tùy chọn chuyên gia
                                    (@member.Name)</h3>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                <!-- Option 1: Bất kỳ ai -->
                                <label
                                    class="group relative flex flex-col p-5 rounded-2xl border-2 border-gray-100 dark:border-[#4a2630] cursor-pointer hover:border-pink-300 hover:bg-pink-50 transition-all h-full">
                                    <input class="peer sr-only" type="radio" name="pref_@member.MemberIndex" value="any"
                                        onchange="toggleDetail(@member.MemberIndex, false)">
                                    <div class="flex items-center gap-4 mb-2">
                                        <div
                                            class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-100 to-white text-primary flex items-center justify-center shadow-sm">
                                            <span class="material-symbols-outlined text-2xl">flash_on</span>
                                        </div>
                                        <h4 class="text-lg font-bold text-text-main dark:text-white">Bất kỳ Chuyên gia nào
                                        </h4>
                                    </div>
                                    <p class="text-sm text-text-muted pl-[64px]">Hệ thống sẽ tự động chọn người phù hợp
                                        nhất.</p>
                                    <div
                                        class="absolute top-4 right-4 text-primary opacity-0 peer-checked:opacity-100 transition-opacity">
                                        <span class="material-symbols-outlined">check_circle</span>
                                    </div>
                                    <div
                                        class="absolute inset-0 border-2 border-primary rounded-2xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity">
                                    </div>
                                </label>

                                <!-- Option 2: Chọn theo dịch vụ -->
                                <label
                                    class="group relative flex flex-col p-5 rounded-2xl border-2 border-gray-100 dark:border-[#4a2630] cursor-pointer hover:border-pink-300 hover:bg-pink-50 transition-all h-full">
                                    <input class="peer sr-only" type="radio" name="pref_@member.MemberIndex"
                                        value="specific" checked onchange="toggleDetail(@member.MemberIndex, true)">
                                    <div class="flex items-center gap-4 mb-2">
                                        <div
                                            class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-100 to-white text-primary flex items-center justify-center shadow-sm">
                                            <span class="material-symbols-outlined text-2xl">person_search</span>
                                        </div>
                                        <h4 class="text-lg font-bold text-text-main dark:text-white">Theo từng dịch vụ</h4>
                                    </div>
                                    <p class="text-sm text-text-muted pl-[64px]">Chọn chuyên gia yêu thích cho từng dịch vụ.
                                    </p>
                                    <div
                                        class="absolute top-4 right-4 text-primary opacity-0 peer-checked:opacity-100 transition-opacity">
                                        <span class="material-symbols-outlined">check_circle</span>
                                    </div>
                                    <div
                                        class="absolute inset-0 border-2 border-primary rounded-2xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity">
                                    </div>
                                </label>
                            </div>

                            <div class="h-px bg-gray-100 dark:bg-[#4a2630] mb-8"></div>

                            <!-- DETAIL LIST (Per Service) -->
                            <div id="detail-list-@member.MemberIndex" class="staff-selection-area space-y-10">
                                @foreach (var service in member.SelectedServices)
                                {
                                    <div>
                                        <div class="flex items-center justify-between mb-4 px-1">
                                            <h4
                                                class="font-bold text-text-main dark:text-white flex items-center gap-2 text-lg">
                                                <span class="w-1.5 h-6 rounded-full bg-primary inline-block"></span>
                                                @service.Name
                                            </h4>
                                            <span
                                                class="text-xs font-medium px-2 py-1 bg-gray-100 dark:bg-[#361c23] rounded text-text-muted">@service.DurationMinutes
                                                phút</span>
                                        </div>

                                        <!-- Horizontal Staff Scroll -->
                                        <div
                                            class="flex gap-4 overflow-x-auto pb-4 px-1 snap-x scrollbar-hide staff-scroll-container">

                                            <!-- Option: Random (Bất kỳ ai) - Luôn hiển thị -->
                                            <div class="flex-shrink-0 snap-start staff-item-container" data-name="bất kỳ ai">
                                                <input class="staff-radio sr-only" type="radio"
                                                    name="staff_@member.MemberIndex@service.Id"
                                                    id="staff_any_@member.MemberIndex@service.Id"
                                                    onchange="selectStaff(@member.MemberIndex, @service.Id, null)" checked>
                                                <!-- Mặc định check Random -->
                                                <label for="staff_any_@member.MemberIndex@service.Id"
                                                    class="flex flex-col items-center gap-3 w-[140px] p-4 rounded-2xl border border-gray-200 cursor-pointer transition-all h-full relative group hover:bg-pink-50">
                                                    <div
                                                        class="w-20 h-20 rounded-full bg-gradient-to-br from-primary/80 to-pink-400 flex items-center justify-center text-white shadow-md">
                                                        <span class="material-symbols-outlined text-3xl">groups</span>
                                                    </div>
                                                    <div class="text-center">
                                                        <span class="block text-sm font-bold text-text-main">Bất kỳ ai</span>
                                                        <span class="block text-xs text-text-muted mt-1">Sớm nhất</span>
                                                    </div>
                                                    <div
                                                        class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-primary text-white flex items-center justify-center opacity-0 transition-opacity">
                                                        <span
                                                            class="material-symbols-outlined text-[12px] font-bold">check</span>
                                                    </div>
                                                </label>
                                            </div>

                                            <!-- Specific Staffs -->
                                            @foreach (var staff in Model.Staffs)
                                            {
                                                <div class="flex-shrink-0 snap-start staff-item-container"
                                                    data-name="@staff.Name.ToLower()">
                                                    <input class="staff-radio sr-only" type="radio"
                                                        name="staff_@member.MemberIndex@service.Id"
                                                        id="staff_@staff.Id@member.MemberIndex@service.Id"
                                                        onchange="selectStaff(@member.MemberIndex, @service.Id, @staff.Id)">
                                                    <label for="staff_@staff.Id@member.MemberIndex@service.Id"
                                                        class="flex flex-col items-center gap-3 w-[140px] p-4 rounded-2xl border border-gray-200 cursor-pointer transition-all h-full relative group hover:bg-pink-50">
                                                        <img src="@staff.Avatar"
                                                            class="w-20 h-20 rounded-full object-cover shadow-md border-2 border-white"
                                                            alt="@staff.Name">
                                                        <div class="text-center">
                                                            <span class="block text-sm font-bold text-text-main">@staff.Name</span>
                                                            <span class="block text-xs text-text-muted mt-1">@staff.Role</span>
                                                        </div>
                                                        <div
                                                            class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-primary text-white flex items-center justify-center opacity-0 transition-opacity">
                                                            <span
                                                                class="material-symbols-outlined text-[12px] font-bold">check</span>
                                                        </div>
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                        <div class="no-staff-msg hidden text-center text-sm text-text-muted mt-2">Không tìm thấy
                                            chuyên gia phù hợp.</div>
                                    </div>
                                }
                            </div>
                        </section>
                    </div>
                }

                <!-- [ĐÃ CẬP NHẬT] THANH ĐIỀU HƯỚNG CUỐI TRANG -->
                <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between">
                    <a asp-action="Step2_Services"
                        class="bg-white border-2 border-gray-200 hover:border-primary/50 text-text-main hover:text-primary font-bold py-3 px-8 rounded-xl transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">arrow_back</span> Quay lại
                    </a>

                    <a asp-action="Step4_Time"
                        class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                        Tiếp tục <span class="material-symbols-outlined text-sm">arrow_forward</span>
                    </a>
                </div>

            </div>

            <!-- RIGHT SIDEBAR (Tóm tắt đặt lịch) -->
            <aside class="w-full lg:w-96 shrink-0 lg:sticky lg:top-24 h-fit">
                <div class="bg-white dark:bg-[#29151b] rounded-2xl p-6 shadow-xl border border-pink-100">
                    <h3 class="text-lg font-bold text-text-main dark:text-white mb-6 flex items-center gap-2">
                        Tóm tắt đặt lịch
                    </h3>
                    <div class="space-y-4 mb-6 relative">
                        <div class="absolute left-[7px] top-2 bottom-4 w-0.5 bg-pink-100 dark:bg-[#4a2630]"></div>

                        <!-- Iterate hiển thị dịch vụ đã chọn -->
                        @foreach (var member in Model.CurrentSession.Members)
                        {
                            @foreach (var s in member.SelectedServices)
                            {
                                <div class="relative pl-6">
                                    <div class="absolute left-0 top-1.5 w-4 h-4 rounded-full border-2 border-primary bg-white">
                                    </div>
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-sm font-semibold text-text-main">@s.Name</p>
                                            <p class="text-xs text-text-muted mt-0.5">
                                                @s.DurationMinutes phút •
                                                <span id="staff-display-@member.MemberIndex@s.Id"
                                                    class="text-primary font-medium">Bất kỳ ai</span>
                                            </p>
                                            @if (Model.CurrentSession.IsGroupBooking)
                                            {
                                                <span class="text-[10px] bg-gray-100 px-1 rounded">@member.Name</span>
                                            }
                                        </div>
                                        <div class="text-right">
                                            <span
                                                class="block text-sm font-medium text-text-main">@s.Price.ToString("N0")</span>
                                            <!-- [MỚI] Link sửa nhanh ở Sidebar -->
                                            <a asp-action="Step2_Services"
                                                class="text-[10px] text-text-muted hover:text-primary underline cursor-pointer">Sửa</a>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <div class="border-t border-dashed border-gray-200 my-4"></div>
                    <div class="space-y-2 mb-6">
                        <div class="flex justify-between items-end pt-2">
                            <div>
                                <span class="block text-sm text-text-muted mb-1">Tổng thời gian</span>
                                <span class="text-base font-semibold text-text-main">@Model.TotalDuration phút</span>
                            </div>
                            <div class="text-right">
                                <span class="block text-sm text-text-muted mb-1">Tổng tiền</span>
                                <span class="text-2xl font-black text-primary-dark">@Model.TotalAmount.ToString("N0")
                                    đ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script>
        // 1. Chuyển tab thành viên
        function switchMember(index) {
            // Tab UI
            document.querySelectorAll('.member-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`btn-member-${index}`).classList.add('active');

            // Show Panel
            document.querySelectorAll('.member-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(`panel-member-${index}`).classList.remove('hidden');
        }

        // 2. Toggle giữa "Bất kỳ ai" và "Theo dịch vụ"
        function toggleDetail(memberIndex, show) {
            const list = document.getElementById(`detail-list-${memberIndex}`);

            if (show) {
                list.classList.remove('collapsed');
                // Logic: Khi bật lại mode detail, giữ nguyên các lựa chọn cũ (không cần reset)
            } else {
                list.classList.add('collapsed');
                // Logic: Khi chọn "Bất kỳ ai" cho cả gói -> Gửi request set All null
                fetch('/Booking/SetStaffAll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `memberIndex=${memberIndex}&staffId=` // Empty staffId = null
                });

                // Reset UI hiển thị bên Sidebar về "Bất kỳ ai"
                document.querySelectorAll(`[id^='staff-display-${memberIndex}']`).forEach(el => {
                    el.innerText = 'Bất kỳ ai';
                });

                // Reset các radio button bên dưới về "Any" để đồng bộ
                document.querySelectorAll(`#detail-list-${memberIndex} input[id^='staff_any_']`).forEach(r => r.checked = true);
            }
        }

        // 3. Chọn nhân viên cụ thể
        function selectStaff(memberIndex, serviceId, staffId) {
            // Update UI Sidebar ngay lập tức cho mượt
            const displayEl = document.getElementById(`staff-display-${memberIndex}${serviceId}`);
            if (displayEl) {
                // Tìm tên nhân viên (hacky way: lấy từ alt ảnh hoặc label)
                if (staffId == null) {
                    displayEl.innerText = "Bất kỳ ai";
                } else {
                    displayEl.innerText = "Đã chọn KTV";
                }
            }

            // Gọi Backend
            const formData = new FormData();
            formData.append('memberIndex', memberIndex);
            formData.append('serviceId', serviceId);
            if (staffId) formData.append('staffId', staffId);

            fetch('/Booking/SetStaff', {
                method: 'POST',
                body: formData
            });
        }

        // 4. Tìm kiếm nhân viên (Client-side filtering)
        function searchStaff() {
            const input = document.getElementById('staff-search-input');
            const filter = input.value.toLowerCase().trim();

            // Tìm tất cả các container chứa list nhân viên
            const scrollContainers = document.querySelectorAll('.staff-scroll-container');

            scrollContainers.forEach(container => {
                const items = container.querySelectorAll('.staff-item-container');
                let hasVisible = false;

                items.forEach(item => {
                    const name = item.getAttribute('data-name');
                    // Luôn hiện "Bất kỳ ai" (nếu bạn muốn) hoặc cũng lọc nó. 
                    // Ở đây tôi chọn: nếu search rỗng -> hiện hết. Nếu search có text -> lọc.
                    // Lưu ý: "Bất kỳ ai" có data-name="bất kỳ ai"

                    if (name.includes(filter)) {
                        item.classList.remove('hidden-by-search');
                        hasVisible = true;
                    } else {
                        item.classList.add('hidden-by-search');
                    }
                });

                // Hiển thị thông báo nếu không tìm thấy trong nhóm này
                const msg = container.nextElementSibling; // div.no-staff-msg
                if (msg && msg.classList.contains('no-staff-msg')) {
                    if (!hasVisible) msg.classList.remove('hidden');
                    else msg.classList.add('hidden');
                }
            });
        }
    </script>
</body>

</html>