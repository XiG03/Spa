@using SpaBookingWeb.ViewModels.Client
@model Step3ViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Chọn Chuyên gia (Bước 3)";
    var currentMemberIndex = 1;
    var totalServicesCount = Model.CurrentSession.Members.Sum(m => m.SelectedServices.Count);
}

<style>
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .member-tab.active {
        background-color: #ec4899;
        color: white;
        border-color: #ec4899;
    }
    .staff-radio:checked+label {
        border-color: #ec4899;
        background-color: rgba(236, 72, 153, 0.05);
    }
    .staff-radio:checked+label .check-icon {
        opacity: 1;
    }
    .staff-selection-area {
        transition: all 0.3s ease;
        max-height: 2000px;
        opacity: 1;
        overflow: hidden;
    }
    .staff-selection-area.collapsed {
        max-height: 0;
        opacity: 0;
        margin: 0 !important;
        padding: 0 !important;
    }
    .staff-item-container.hidden-by-search {
        display: none !important;
    }
</style>

<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- STEP INDICATOR -->
    <div class="mb-8">
        <div class="flex items-center justify-between w-full relative">
            <div class="absolute left-0 top-1/2 -translate-y-1/2 w-full h-1 bg-gray-200 dark:bg-gray-800 rounded-full -z-10"></div>
            <div class="absolute left-0 top-1/2 -translate-y-1/2 w-[60%] h-1 bg-primary rounded-full -z-10 transition-all duration-300"></div>
            
            <div class="flex flex-col items-center gap-2">
                <a asp-action="Index" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-lg hover:bg-primary-dark transition-colors" title="Quay lại chọn Loại">1</a>
            </div>
            <div class="flex flex-col items-center gap-2">
                <a asp-action="Step2_Services" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-lg hover:bg-primary-dark transition-colors" title="Quay lại chọn Dịch vụ">2</a>
            </div>
            <div class="flex flex-col items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm shadow-lg">3</div>
                <span class="text-xs font-bold text-primary">KTV</span>
            </div>
            <div class="flex flex-col items-center gap-2 opacity-50">
                <div class="w-8 h-8 rounded-full bg-white border-2 border-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm">4</div>
                <span class="text-xs font-medium text-gray-500">Giờ</span>
            </div>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-8 items-start relative">
        <div class="flex-1 w-full min-w-0 flex flex-col gap-6">

            <!-- REVIEW STEP TRƯỚC -->
            <section class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-sm border border-pink-100 dark:border-gray-800 flex items-center justify-between opacity-80 hover:opacity-100 transition-opacity">
                <div class="flex items-center gap-4">
                    <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold text-sm shrink-0">
                        <span class="material-symbols-outlined text-lg">check</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Dịch vụ</h3>
                        <p class="text-sm text-gray-500">@totalServicesCount dịch vụ đã chọn</p>
                    </div>
                </div>
                <a asp-action="Step2_Services" class="text-primary font-semibold text-sm hover:underline px-3 py-1 flex items-center gap-1">
                    Thay đổi <span class="material-symbols-outlined text-sm">edit</span>
                </a>
            </section>

            <!-- GROUP TABS -->
            @if (Model.CurrentSession.IsGroupBooking)
            {
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-4 shadow-sm border border-pink-100 dark:border-gray-800">
                    <h3 class="text-sm font-bold text-gray-500 uppercase mb-3">Chọn chuyên gia cho:</h3>
                    <div class="flex gap-2 flex-wrap">
                        @foreach (var member in Model.CurrentSession.Members)
                        {
                            <button onclick="switchMember(@member.MemberIndex)" id="btn-member-@member.MemberIndex"
                                class="member-tab px-4 py-2 rounded-xl border border-pink-100 text-sm font-bold transition-all hover:border-primary @(member.MemberIndex == 1 ? "active" : "")">
                                <span class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[18px]">person</span>
                                    @member.Name
                                </span>
                            </button>
                        }
                    </div>
                </div>
            }

            @foreach (var member in Model.CurrentSession.Members)
            {
                <div id="panel-member-@member.MemberIndex" class="member-panel @(member.MemberIndex == 1 ? "" : "hidden")">

                    <!-- OPTION SELECTION -->
                    <section class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border-2 border-primary/20">
                        <div class="flex items-center gap-3 mb-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Tùy chọn chuyên gia (@member.Name)</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <!-- Option 1: Bất kỳ ai -->
                            <label class="group relative flex flex-col p-5 rounded-2xl border-2 border-gray-100 dark:border-gray-800 cursor-pointer hover:border-pink-300 hover:bg-pink-50 transition-all h-full">
                                <input class="peer sr-only" type="radio" name="pref_@member.MemberIndex" value="any"
                                    onchange="toggleDetail(@member.MemberIndex, false)">
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-100 to-white text-primary flex items-center justify-center shadow-sm">
                                        <span class="material-symbols-outlined text-2xl">flash_on</span>
                                    </div>
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">Bất kỳ Chuyên gia nào</h4>
                                </div>
                                <p class="text-sm text-gray-500 pl-[64px]">Hệ thống sẽ tự động chọn người phù hợp nhất.</p>
                                <div class="absolute top-4 right-4 text-primary opacity-0 peer-checked:opacity-100 transition-opacity">
                                    <span class="material-symbols-outlined">check_circle</span>
                                </div>
                                <div class="absolute inset-0 border-2 border-primary rounded-2xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></div>
                            </label>

                            <!-- Option 2: Chọn theo dịch vụ -->
                            <label class="group relative flex flex-col p-5 rounded-2xl border-2 border-gray-100 dark:border-gray-800 cursor-pointer hover:border-pink-300 hover:bg-pink-50 transition-all h-full">
                                <input class="peer sr-only" type="radio" name="pref_@member.MemberIndex" value="specific" checked onchange="toggleDetail(@member.MemberIndex, true)">
                                <div class="flex items-center gap-4 mb-2">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-100 to-white text-primary flex items-center justify-center shadow-sm">
                                        <span class="material-symbols-outlined text-2xl">person_search</span>
                                    </div>
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white">Theo từng dịch vụ</h4>
                                </div>
                                <p class="text-sm text-gray-500 pl-[64px]">Chọn chuyên gia yêu thích cho từng dịch vụ.</p>
                                <div class="absolute top-4 right-4 text-primary opacity-0 peer-checked:opacity-100 transition-opacity">
                                    <span class="material-symbols-outlined">check_circle</span>
                                </div>
                                <div class="absolute inset-0 border-2 border-primary rounded-2xl opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></div>
                            </label>
                        </div>

                        <div class="h-px bg-gray-100 dark:bg-gray-800 mb-8"></div>

                        <!-- DETAIL LIST (Per Service) -->
                        <div id="detail-list-@member.MemberIndex" class="staff-selection-area space-y-10">
                            <!-- SEARCH BAR integrated in section -->
                             <div class="relative w-full max-w-sm mb-4">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-500 text-[20px]">search</span>
                                </span>
                                <input id="staff-search-input-@member.MemberIndex" onkeyup="searchStaff(@member.MemberIndex)"
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-200 rounded-xl bg-white dark:bg-gray-800 text-sm text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="Tìm kiếm chuyên gia..." type="text" />
                            </div>

                            @foreach (var service in member.SelectedServices)
                            {
                                <div class="staff-service-group-@member.MemberIndex">
                                    <div class="flex items-center justify-between mb-4 px-1">
                                        <h4 class="font-bold text-gray-900 dark:text-white flex items-center gap-2 text-lg">
                                            <span class="w-1.5 h-6 rounded-full bg-primary inline-block"></span>
                                            @service.Name
                                        </h4>
                                        <span class="text-xs font-medium px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-gray-500">@service.DurationMinutes phút</span>
                                    </div>

                                    <div class="flex gap-4 overflow-x-auto pb-4 px-1 snap-x scrollbar-hide staff-scroll-container">
                                        <div class="flex-shrink-0 snap-start staff-item-container" data-name="bất kỳ ai">
                                            <input class="staff-radio sr-only" type="radio"
                                                name="staff_@member.MemberIndex@service.Id"
                                                id="staff_any_@member.MemberIndex@service.Id"
                                                onchange="selectStaff(@member.MemberIndex, @service.Id, null)" checked>
                                            <label for="staff_any_@member.MemberIndex@service.Id"
                                                class="flex flex-col items-center gap-3 w-[140px] p-4 rounded-2xl border border-gray-200 cursor-pointer transition-all h-full relative group hover:bg-pink-50">
                                                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-primary/80 to-pink-400 flex items-center justify-center text-white shadow-md">
                                                    <span class="material-symbols-outlined text-3xl">groups</span>
                                                </div>
                                                <div class="text-center">
                                                    <span class="block text-sm font-bold text-gray-900">Bất kỳ ai</span>
                                                    <span class="block text-xs text-gray-500 mt-1">Sớm nhất</span>
                                                </div>
                                                <div class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-primary text-white flex items-center justify-center opacity-0 transition-opacity">
                                                    <span class="material-symbols-outlined text-[12px] font-bold">check</span>
                                                </div>
                                            </label>
                                        </div>

                                        @foreach (var staff in Model.Staffs)
                                        {
                                            <div class="flex-shrink-0 snap-start staff-item-container" data-name="@staff.Name.ToLower()">
                                                <input class="staff-radio sr-only" type="radio"
                                                    name="staff_@member.MemberIndex@service.Id"
                                                    id="staff_@staff.Id@member.MemberIndex@service.Id"
                                                    onchange="selectStaff(@member.MemberIndex, @service.Id, @staff.Id)">
                                                <label for="staff_@staff.Id@member.MemberIndex@service.Id"
                                                    class="flex flex-col items-center gap-3 w-[140px] p-4 rounded-2xl border border-gray-200 cursor-pointer transition-all h-full relative group hover:bg-pink-50">
                                                    <img src="@staff.Avatar" class="w-20 h-20 rounded-full object-cover shadow-md border-2 border-white" alt="@staff.Name">
                                                    <div class="text-center">
                                                        <span class="block text-sm font-bold text-gray-900">@staff.Name</span>
                                                        <span class="block text-xs text-gray-500 mt-1">@staff.Role</span>
                                                    </div>
                                                    <div class="check-icon absolute top-3 right-3 w-5 h-5 rounded-full bg-primary text-white flex items-center justify-center opacity-0 transition-opacity">
                                                        <span class="material-symbols-outlined text-[12px] font-bold">check</span>
                                                    </div>
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    <div class="no-staff-msg hidden text-center text-sm text-gray-500 mt-2">Không tìm thấy chuyên gia phù hợp.</div>
                                </div>
                            }
                        </div>
                    </section>
                </div>
            }

            <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between">
                <a asp-action="Step2_Services"
                    class="bg-white border-2 border-gray-200 hover:border-primary/50 text-gray-900 hover:text-primary font-bold py-3 px-8 rounded-xl transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">arrow_back</span> Quay lại
                </a>
                <a asp-action="Step4_Time"
                    class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-2 transition-all">
                    Tiếp tục <span class="material-symbols-outlined text-sm">arrow_forward</span>
                </a>
            </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <aside class="w-full lg:w-96 shrink-0 lg:sticky lg:top-24 h-fit">
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-xl border border-pink-100 dark:border-gray-800">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    Tóm tắt đặt lịch
                </h3>
                <div class="space-y-4 mb-6 relative">
                    <div class="absolute left-[7px] top-2 bottom-4 w-0.5 bg-pink-100 dark:bg-gray-800"></div>

                    @foreach (var member in Model.CurrentSession.Members)
                    {
                        @foreach (var s in member.SelectedServices)
                        {
                            <div class="relative pl-6">
                                <div class="absolute left-0 top-1.5 w-4 h-4 rounded-full border-2 border-primary bg-white"></div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-semibold text-gray-900">@s.Name</p>
                                        <p class="text-xs text-gray-500 mt-0.5">
                                            @s.DurationMinutes phút •
                                            <span id="staff-display-@member.MemberIndex@s.Id" class="text-primary font-medium">Bất kỳ ai</span>
                                        </p>
                                        @if (Model.CurrentSession.IsGroupBooking)
                                        {
                                            <span class="text-[10px] bg-gray-100 px-1 rounded">@member.Name</span>
                                        }
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-sm font-medium text-gray-900">@s.Price.ToString("N0")</span>
                                        <a asp-action="Step2_Services" class="text-[10px] text-gray-500 hover:text-primary underline cursor-pointer">Sửa</a>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="border-t border-dashed border-gray-200 dark:border-gray-700 my-4"></div>
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between items-end pt-2">
                        <div>
                            <span class="block text-sm text-gray-500 mb-1">Tổng thời gian</span>
                            <span class="text-base font-semibold text-gray-900">@Model.TotalDuration phút</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-sm text-gray-500 mb-1">Tổng tiền</span>
                            <span class="text-2xl font-black text-primary-dark">@Model.TotalAmount.ToString("N0") đ</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    // 1. Chuyển tab thành viên
    function switchMember(index) {
        document.querySelectorAll('.member-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`btn-member-${index}`).classList.add('active');

        document.querySelectorAll('.member-panel').forEach(p => p.classList.add('hidden'));
        document.getElementById(`panel-member-${index}`).classList.remove('hidden');
    }

    // 2. Toggle giữa "Bất kỳ ai" và "Theo dịch vụ"
    function toggleDetail(memberIndex, show) {
        const list = document.getElementById(`detail-list-${memberIndex}`);

        if (show) {
            list.classList.remove('collapsed');
        } else {
            list.classList.add('collapsed');
            fetch('/Booking/SetStaffAll', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `memberIndex=${memberIndex}&staffId=`
            });

            document.querySelectorAll(`[id^='staff-display-${memberIndex}']`).forEach(el => {
                el.innerText = 'Bất kỳ ai';
            });
            document.querySelectorAll(`#detail-list-${memberIndex} input[id^='staff_any_']`).forEach(r => r.checked = true);
        }
    }

    // 3. Chọn nhân viên cụ thể
    function selectStaff(memberIndex, serviceId, staffId) {
        const displayEl = document.getElementById(`staff-display-${memberIndex}${serviceId}`);
        if (displayEl) {
            if (staffId == null) {
                displayEl.innerText = "Bất kỳ ai";
            } else {
                displayEl.innerText = "Đã chọn KTV";
            }
        }

        const formData = new FormData();
        formData.append('memberIndex', memberIndex);
        formData.append('serviceId', serviceId);
        if (staffId) formData.append('staffId', staffId);

        fetch('/Booking/SetStaff', {
            method: 'POST',
            body: formData
        });
    }

    // 4. Tìm kiếm nhân viên
    function searchStaff(memberIndex) {
        // Nếu không truyền memberIndex (trường hợp tìm kiếm chung nếu có), hoặc truyền cụ thể
        // Ở đây tôi sửa logic để search theo member panel
        const input = document.getElementById(`staff-search-input-${memberIndex}`);
        const filter = input.value.toLowerCase().trim();
        const container = document.getElementById(`detail-list-${memberIndex}`);
        
        // Tìm trong từng service group
        const serviceGroups = container.querySelectorAll(`[class^='staff-service-group-']`); // Hoặc selector tốt hơn

        // Logic search cũ tìm class="staff-scroll-container"
        const scrollContainers = container.querySelectorAll('.staff-scroll-container');

        scrollContainers.forEach(scrollContainer => {
             const items = scrollContainer.querySelectorAll('.staff-item-container');
             let hasVisible = false;

             items.forEach(item => {
                 const name = item.getAttribute('data-name');
                 if (name.includes(filter)) {
                     item.classList.remove('hidden-by-search');
                     hasVisible = true;
                 } else {
                     item.classList.add('hidden-by-search');
                 }
             });
             
             // Có thể hide msg nếu cần
             const msg = scrollContainer.nextElementSibling;
             if(msg && msg.classList.contains('no-staff-msg')) {
                 if(!hasVisible) msg.classList.remove('hidden');
                 else msg.classList.add('hidden');
             }
        });
    }
</script>